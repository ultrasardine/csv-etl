{% extends "base.html" %}

{% block title %}Visual Mapping - {{ mapping.name }}{% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='vendor/jsplumb.min.js') }}"></script>
<style>
    #mappingContainer {
        display: flex;
        justify-content: space-between;
        padding: 30px 50px;
        min-height: 500px;
        position: relative;
        background: #fafafa;
        border-radius: 8px;
        overflow: visible;
    }
    
    .column-panel {
        width: 280px;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: relative;
        /* Remove z-index so lines can appear on top */
    }
    
    .column-panel h5 {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
        font-size: 1rem;
    }
    
    .column-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.9rem;
        position: relative;
        /* No z-index here either */
    }
    
    .column-item:hover {
        background: #e9ecef;
    }
    
    .column-item .col-type {
        font-size: 0.7rem;
        color: #6c757d;
        float: right;
        margin-top: 2px;
    }
    
    /* Destination states */
    .dest-item.connected {
        background: #d1e7dd;
        border-color: #198754;
    }
    
    .dest-item.has-constant {
        background: #fff3cd;
        border-color: #ffc107;
    }
    
    .dest-item.unconnected {
        opacity: 0.6;
        border-style: dashed;
    }
    
    /* Constant badge - inside the dest item, on the right side */
    .constant-badge {
        display: inline-block;
        background: #ffc107;
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        cursor: pointer;
        white-space: nowrap;
        margin-left: 8px;
        float: right;
    }
    
    .constant-badge:hover {
        background: #e0a800;
    }
    
    /* Toolbar */
    .mapping-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: #e9ecef;
        border-radius: 8px;
    }
    
    .mapping-stats {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
    }
    
    .stat-value {
        font-weight: 600;
    }
    
    /* jsPlumb SVG layer - on top of everything */
    svg.jtk-connector {
        z-index: 50 !important;
    }
    
    .jtk-endpoint {
        z-index: 60 !important;
    }
    
    .jtk-overlay {
        z-index: 70 !important;
    }
    
    /* Transform label */
    .transform-label {
        background: #198754;
        color: white;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 0.75rem;
        cursor: pointer;
    }
    
    .transform-label:hover {
        background: #157347;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <a href="{{ url_for('list_mappings') }}" class="btn btn-outline-secondary btn-sm me-2">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <span class="h5 mb-0">{{ mapping.name }}</span>
        <small class="text-muted ms-2">Visual Editor</small>
    </div>
    <div>
        <a href="{{ url_for('edit_mapping', mapping_id=mapping.id) }}" class="btn btn-outline-secondary btn-sm me-2">
            <i class="bi bi-table"></i> Table View
        </a>
        <button id="saveBtn" class="btn btn-primary btn-sm">
            <i class="bi bi-save"></i> Save Mapping
        </button>
    </div>
</div>

<div class="mapping-toolbar">
    <div class="mapping-stats">
        <span>Source: <span class="stat-value">{{ source.name }}</span></span>
        <span>Destination: <span class="stat-value">{{ destination.name }}</span></span>
        <span>Connections: <span class="stat-value" id="connectionCount">0</span></span>
    </div>
    <button class="btn btn-outline-danger btn-sm" id="clearAllBtn">
        <i class="bi bi-trash"></i> Clear All
    </button>
</div>

<div class="card">
    <div class="card-body p-0">
        <div id="mappingContainer">
            <div class="column-panel" id="sourcePanel">
                <h5><i class="bi bi-box-arrow-in-right text-primary"></i> {{ source.name }}</h5>
                {% for col in source.columns %}
                <div class="column-item source-item" id="src_{{ loop.index0 }}" data-col="{{ col.name }}">
                    {{ col.name }}
                    <span class="col-type">{{ col.type.value }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div class="column-panel" id="destPanel">
                <h5><i class="bi bi-box-arrow-right text-success"></i> {{ destination.name }}</h5>
                {% for col in destination.columns %}
                <div class="column-item dest-item unconnected" id="dst_{{ loop.index0 }}" data-col="{{ col.name }}">
                    {{ col.name }}
                    <span class="col-type">{{ col.type.value }}</span>
                    {% if col.required %}<span class="badge bg-danger" style="font-size:0.6rem">req</span>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info mt-3 small">
    <i class="bi bi-info-circle"></i>
    <strong>Usage:</strong> Drag from source to destination to connect. Click the label to configure transform. Click line to delete. Double-click destination for constant value.
</div>

<!-- Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Transform</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cfgConnId">
                <div class="mb-3">
                    <label class="form-label">Source → Destination</label>
                    <input type="text" class="form-control" id="cfgFields" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Transform Type</label>
                    <select class="form-select" id="cfgType">
                        {% for tt in transform_types %}
                        <option value="{{ tt.value }}">{{ tt.value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Config (JSON)</label>
                    <textarea class="form-control" id="cfgJson" rows="3"></textarea>
                    <small class="text-muted" id="cfgHelp"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="cfgDeleteBtn"><i class="bi bi-trash"></i> Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="cfgSaveBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Constant Modal -->
<div class="modal fade" id="constModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Constant Value</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="constCol">
                <div class="mb-3">
                    <label class="form-label">Field: <strong id="constField"></strong></label>
                    <input type="text" class="form-control" id="constVal" placeholder="Enter value...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="constRemoveBtn">Remove</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="constSaveBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var mappingId = "{{ mapping.id }}";
var existingMappings = {{ mapping.to_dict().field_mappings | tojson | safe }};

// Maps: column name -> element id
var srcMap = {}, dstMap = {};
{% for col in source.columns %}
srcMap["{{ col.name }}"] = "src_{{ loop.index0 }}";
{% endfor %}
{% for col in destination.columns %}
dstMap["{{ col.name }}"] = "dst_{{ loop.index0 }}";
{% endfor %}

var connData = {};  // connId -> {src, dst, type, config}
var constants = {}; // dstCol -> value
var jsp;

jsPlumb.ready(function() {
    jsp = jsPlumb.getInstance({
        Container: "mappingContainer",
        Connector: ["Bezier", {curviness: 50}],
        Endpoint: ["Dot", {radius: 6}],
        EndpointStyle: {fill: "#0d6efd"},
        EndpointHoverStyle: {fill: "#198754"},
        PaintStyle: {stroke: "#0d6efd", strokeWidth: 2},
        HoverPaintStyle: {stroke: "#dc3545", strokeWidth: 3},
        ConnectionOverlays: [
            ["Arrow", {location: 1, width: 10, length: 8}],
            ["Label", {label: "direct", location: 0.5, cssClass: "transform-label", id: "lbl"}]
        ]
    });
    
    // Make sources draggable endpoints
    document.querySelectorAll(".source-item").forEach(function(el) {
        jsp.addEndpoint(el, {
            anchor: "Right",
            isSource: true,
            maxConnections: -1,
            uuid: "s-" + el.dataset.col
        });
    });
    
    // Make destinations drop targets
    document.querySelectorAll(".dest-item").forEach(function(el) {
        jsp.addEndpoint(el, {
            anchor: "Left", 
            isTarget: true,
            maxConnections: 1,
            uuid: "d-" + el.dataset.col
        });
        
        el.addEventListener("dblclick", function(e) {
            openConstModal(el.dataset.col);
        });
    });
    
    // New connection
    jsp.bind("connection", function(info) {
        var srcCol = info.source.dataset.col;
        var dstCol = info.target.dataset.col;
        connData[info.connection.id] = {src: srcCol, dst: dstCol, type: "direct", config: {}};
        info.connection.getOverlay("lbl").setLabel("direct");
        updateDstStyle(dstCol);
        updateCount();
    });
    
    // Click connection line to delete (but not label)
    jsp.bind("click", function(conn, e) {
        // Don't trigger if clicking on the label
        if (e.target.classList.contains("transform-label") || e.target.closest(".transform-label")) {
            return;
        }
        if (confirm("Delete connection?")) {
            var d = connData[conn.id];
            delete connData[conn.id];
            jsp.deleteConnection(conn);
            if (d) updateDstStyle(d.dst);
            updateCount();
        }
    });
    
    // Load existing
    existingMappings.forEach(function(m) {
        if (m.source_field && srcMap[m.source_field] && dstMap[m.destination_field]) {
            var c = jsp.connect({uuids: ["s-" + m.source_field, "d-" + m.destination_field]});
            if (c) {
                connData[c.id] = {src: m.source_field, dst: m.destination_field, type: m.transform_type || "direct", config: m.transform_config || {}};
                c.getOverlay("lbl").setLabel(m.transform_type || "direct");
                updateDstStyle(m.destination_field);
            }
        } else if (m.transform_type === "constant" && m.transform_config) {
            constants[m.destination_field] = m.transform_config.value;
            updateDstStyle(m.destination_field);
            showConstBadge(m.destination_field);
        }
    });
    updateCount();
    
    // Force jsPlumb to recalculate positions after layout settles
    setTimeout(function() {
        jsp.repaintEverything();
    }, 100);
    
    // Repaint on window resize
    window.addEventListener("resize", function() {
        jsp.repaintEverything();
    });
    
    // Make labels clickable for config
    document.getElementById("mappingContainer").addEventListener("click", function(e) {
        if (e.target.classList.contains("transform-label")) {
            var conns = jsp.getConnections();
            for (var i = 0; i < conns.length; i++) {
                var lbl = conns[i].getOverlay("lbl");
                if (lbl && lbl.canvas === e.target) {
                    openCfgModal(conns[i]);
                    break;
                }
            }
        }
    });
});

function updateDstStyle(col) {
    var el = document.getElementById(dstMap[col]);
    if (!el) return;
    var hasConn = Object.values(connData).some(function(d) { return d.dst === col; });
    var hasConst = constants.hasOwnProperty(col);
    el.classList.remove("connected", "has-constant", "unconnected");
    el.classList.add(hasConn ? "connected" : hasConst ? "has-constant" : "unconnected");
}

function showConstBadge(col) {
    var el = document.getElementById(dstMap[col]);
    if (!el) return;
    var old = el.querySelector(".constant-badge");
    if (old) old.remove();
    if (constants.hasOwnProperty(col)) {
        var b = document.createElement("span");
        b.className = "constant-badge";
        b.textContent = "= " + (constants[col] || "?");
        b.onclick = function(e) { e.stopPropagation(); openConstModal(col); };
        el.appendChild(b);
    }
}

function updateCount() {
    document.getElementById("connectionCount").textContent = Object.keys(connData).length + Object.keys(constants).length;
}

function openCfgModal(conn) {
    var d = connData[conn.id];
    if (!d) return;
    document.getElementById("cfgConnId").value = conn.id;
    document.getElementById("cfgFields").value = d.src + " → " + d.dst;
    document.getElementById("cfgType").value = d.type;
    document.getElementById("cfgJson").value = Object.keys(d.config).length ? JSON.stringify(d.config, null, 2) : "";
    updateCfgHelp();
    var modal = new bootstrap.Modal(document.getElementById("configModal"));
    modal.show();
}

function openConstModal(col) {
    document.getElementById("constCol").value = col;
    document.getElementById("constField").textContent = col;
    document.getElementById("constVal").value = constants[col] || "";
    var modal = new bootstrap.Modal(document.getElementById("constModal"));
    modal.show();
}

function hideModal(id) {
    var el = document.getElementById(id);
    var modal = bootstrap.Modal.getInstance(el);
    if (modal) {
        modal.hide();
    }
    // Clean up backdrop and body class after hide
    el.addEventListener('hidden.bs.modal', function handler() {
        el.removeEventListener('hidden.bs.modal', handler);
        document.body.classList.remove('modal-open');
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
    }, {once: true});
}

function updateCfgHelp() {
    var t = document.getElementById("cfgType").value;
    var h = {
        direct: "No config needed",
        constant: '{"value": "USD"}',
        date_format: '{"input_format": "%Y-%m-%dT%H:%M:%S", "output_format": "%Y-%m-%d"}',
        lookup: '{"BUY": "B", "SELL": "S", "_default": null}',
        suffix: '{"value": "-USD"}',
        prefix: '{"value": "PRE_"}',
        formula: '{"expression": "Quantity * Price"}'
    };
    document.getElementById("cfgHelp").textContent = h[t] || "";
}

document.getElementById("cfgType").addEventListener("change", updateCfgHelp);

document.getElementById("cfgSaveBtn").addEventListener("click", function() {
    var id = document.getElementById("cfgConnId").value;
    var d = connData[id];
    if (!d) return;
    d.type = document.getElementById("cfgType").value;
    var js = document.getElementById("cfgJson").value.trim();
    if (js) {
        try { d.config = JSON.parse(js); } catch(e) { alert("Invalid JSON"); return; }
    } else {
        d.config = {};
    }
    // Update label
    jsp.getConnections().forEach(function(c) {
        if (c.id === id) c.getOverlay("lbl").setLabel(d.type);
    });
    hideModal("configModal");
});

document.getElementById("cfgDeleteBtn").addEventListener("click", function() {
    var id = document.getElementById("cfgConnId").value;
    jsp.getConnections().forEach(function(c) {
        if (c.id === id) {
            var d = connData[id];
            delete connData[id];
            jsp.deleteConnection(c);
            if (d) updateDstStyle(d.dst);
            updateCount();
        }
    });
    hideModal("configModal");
});

document.getElementById("constSaveBtn").addEventListener("click", function() {
    var col = document.getElementById("constCol").value;
    var val = document.getElementById("constVal").value;
    // Remove existing connection
    jsp.getConnections().forEach(function(c) {
        if (connData[c.id] && connData[c.id].dst === col) {
            delete connData[c.id];
            jsp.deleteConnection(c);
        }
    });
    constants[col] = val;
    updateDstStyle(col);
    showConstBadge(col);
    updateCount();
    hideModal("constModal");
});

document.getElementById("constRemoveBtn").addEventListener("click", function() {
    var col = document.getElementById("constCol").value;
    delete constants[col];
    updateDstStyle(col);
    showConstBadge(col);
    updateCount();
    hideModal("constModal");
});

document.getElementById("clearAllBtn").addEventListener("click", function() {
    if (!confirm("Clear all?")) return;
    jsp.deleteEveryConnection();
    connData = {};
    constants = {};
    document.querySelectorAll(".dest-item").forEach(function(el) {
        var b = el.querySelector(".constant-badge");
        if (b) b.remove();
        updateDstStyle(el.dataset.col);
    });
    updateCount();
});

document.getElementById("saveBtn").addEventListener("click", function() {
    var mappings = [];
    Object.values(connData).forEach(function(d) {
        mappings.push({destination_field: d.dst, source_field: d.src, transform_type: d.type, transform_config: d.config});
    });
    Object.keys(constants).forEach(function(col) {
        mappings.push({destination_field: col, source_field: null, transform_type: "constant", transform_config: {value: constants[col]}});
    });
    
    fetch("/api/mappings/" + mappingId + "/save", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({field_mappings: mappings, filter_rules: []})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        alert(data.success ? "Saved!" : "Error: " + data.error);
    })
    .catch(function(e) { alert("Error: " + e); });
});
</script>
{% endblock %}
